<html>
    <head>
        <!--https://codepen.io/jeansarlon/pen/WpZNda-->
        <style>
            .board {
                width:675px;
                display:grid;
                grid-template-columns: repeat(15, 45px);
                grid-template-rows: repeat(15, 45px);
                grid-gap:0px;
                grid-auto-flow:row;
                border-bottom: 1px solid black;
                border-right: 1px solid black;
            }

            .player-letters {
                width:315px;
                display:grid;
                grid-template-columns: repeat(7, 45px);
                grid-template-rows: 45px;
                grid-gap:0px;
                border-bottom: 1px solid black;
                border-right: 1px solid black;
            }

            .board-cell {

                color: #000;
                text-align: center;
                vertical-align:center;
                border-top: 1px solid black;
                border-left: 1px solid black;
                cursor:pointer;
            }

            .empty-cell {
                background-color: tan;
            }

            .tile-cell {
                background-color: sandybrown;
                font-size:175%;
            }

            .selected-word-cell {
                background-color: darkgreen;
                font-size:175%;
            }

            .modifier-cell {
                font-size: 90%;
            }

            .double-letter-cell {
                background-color: lightblue;
            }

            .double-word-cell {
                background-color:pink;
            }

            .triple-letter-cell {
                background-color: royalblue;
            }

            .triple-word-cell {
                background-color:red;
            }

            .selected-cell {
                border: 3px solid yellow;
            }

            #find-top-words {
                font-weight:bold;
                font-size:15px;

            }

            #app {
                display:flex;
                flex-direction: row;
                justify-content: center;
            }

            #left {
                flex:1;
            }

            #right {
                padding-left: 10px;
                border-left: 3px solid black;
                flex:1
            }

            #top-words {
                overflow:scroll;
                height:500px;
                padding-top:5px;
            }

            .top-word-entry {
                margin-bottom: 5px;
            }

            .top-word-entry-btn {
                border: 1px solid black;
                cursor:pointer;
                margin-left:5px;
            }

            .hide-btn {
                background-color:red;
            }

            .view-btn {
                background-color:green;
            }

            .place-btn {
                background-color:lightblue;
            }



        </style>
    </head>
    <body>
        <div id="app">
            <div id="left">

                <h3>Instructions:</h3>
                <ul>
                    <li>
                        Click on positions <a href="#board-header">on the board</a> or slots on <a href="#player-letters-header">player letters</a>
                        and type to add letters to the board/your hand.
                    </li>
		    <li>
			Hit backspace to delete existing tiles/board letters.
		    </li>
                    <li>
                         On the board, type in capital letters to signify blanks (e.g "A" is a blank tile whose value is "a").
                    </li>
                    <li>
                        Within player letters, hit the spacebar to add a blank tile.
                    </li>
                    <li>
                     On both the board and in player letters, you can use arrow keys to navigate.
                    </li>
                    <li>
                        Click the button below player letters to generate the top scoring words for the board.
                    </li>
                </ul>

                <h3 id="player-letters-header">Player Letters:</h3>
                <div>
                    <div id="player-letters" class="player-letters" style="margin-bottom:20px">

                    </div>
                    <button id="find-top-words">
                        Click To Generate Top Scoring Words
                    </button>
                </div>

                <h3 id="board-header">Board:</h3>
                <div id="board" class="board" style="margin-top:20px">
                </div>

            </div>
            <div id="right">
                <h3>Top Scoring Words:</h3>
                <div id="top-words">

                </div>
            </div>
        </div>
        <script>

            const LOWER_A_CODE = 'a'.charCodeAt(0);
            const LOWER_Z_CODE = 'z'.charCodeAt(0);

            const UPPER_A_CODE = 'A'.charCodeAt(0);
            const UPPER_Z_CODE = 'Z'.charCodeAt(0);

            const BACKSPACE_KEY = "Backspace";
            const SPACE_KEY = " ";

            const UP_KEY = "ArrowUp";
            const DOWN_KEY = "ArrowDown";
            const LEFT_KEY = "ArrowLeft";
            const RIGHT_KEY = "ArrowRight";
            const ARROW_KEYS = [UP_KEY, DOWN_KEY, LEFT_KEY, RIGHT_KEY];

            let selectedRow = undefined;
            let selectedCol = undefined;
            let selectedPlayerLetter = undefined;

            let placedLetters = {}; // {7: {5:'d', 6:'o', 7:'g'}};
            let playerLetters = new Array(7);

            //Array of solution responses from server
            let topWords = [];
            //Top word that we are currently viewing
            let selectedTopWordIdx = undefined;
            //coordinates of letters in our top word
            let selectedTopWordLetters = {}; // {7: {5:'d', 6:'o', 7:'g'}};

            let modifiers = [
                'T  d   T   d  T',
                ' D   t   t   D ',
                '  D   d d   D  ',
                'd  D   d   D  d',
                '    D     D    ',
                ' t   t   t   t ',
                '  d   d d   d  ',
                'T  d   D   d  T',
                '  d   d d   d  ',
                ' t   t   t   t ',
                '    D     D    ',
                'd  D   d   D  d',
                '  D   d d   D  ',
                ' D   t   t   D ',
                'T  d   T   d  T'
            ];

            let modifierToClass = {
                'd': "double-letter-cell",
                "D": "double-word-cell",
                "t": "triple-letter-cell",
                "T": "triple-word-cell"
            };

            let modifierToText = {
                'd': "Double Letter",
                'D': "Double Word",
                "t": "Triple Letter",
                'T': "Triple Word"
            };

            function createBoardCell(row, col) {
                let cell = document.createElement("div");
                cell.classList.add("board-cell");

                let placedLetter = (placedLetters[row] ||{})[col];
                let selectedTopWordLetter = (selectedTopWordLetters[row] || {})[col];

                let modifier = modifiers[row][col];

                if(placedLetter) {
                    cell.innerText = placedLetter;
                    cell.classList.add("tile-cell");
                } else if(selectedTopWordLetter) {
                     cell.innerText = selectedTopWordLetter;
                     cell.classList.add("selected-word-cell");
                 } else if (modifier !== ' ') {
                    let modClass = modifierToClass[modifier];
                    cell.innerText = modifierToText[modifier];
                    cell.classList.add("modifier-cell");
                    cell.classList.add(modClass);
                } else {
                    cell.classList.add("empty-cell");
                }

                if(selectedCol === col && selectedRow === row){
                    cell.classList.add("selected-cell");
                }

                cell.onclick = () => {
                    selectedCol = col;
                    selectedRow = row;
                    selectedPlayerLetter = undefined;
                    render();
                };

                return cell;
            }

            function renderBoard() {
                let board = document.getElementById("board");
                board.innerHTML = "";

                for(let row = 0; row<15; row++) {
                    for(let col = 0; col<15; col++) {
                        let cell = createBoardCell(row,col);
                        board.append(cell);
                    }
                }
            }

            function createPlayerLetterCell(letterIdx){
                let cell = document.createElement("div");
                cell.classList.add("board-cell");

                let letter = playerLetters[letterIdx];

                if(letter) {
                    cell.innerText = letter;
                    cell.classList.add("tile-cell");
                } else {
                    cell.classList.add("empty-cell");
                }


                cell.onclick = () => {
                    selectedCol = undefined;
                    selectedRow = undefined;
                    selectedPlayerLetter = letterIdx;
                    render();
                };


                if(selectedPlayerLetter === letterIdx){
                    cell.classList.add("selected-cell");
                }

                return cell;
            }


            function placeTopWordLetters(topWord, letterGrid){

                let row = topWord.start_coord.row;
                let col = topWord.start_coord.col;
                let word = topWord.word;
                for(let i = 0; i<word.length; i++){

                    letterGrid[row] = letterGrid[row] || {};
                    letterGrid[row][col] = word[i];

                    if(topWord.direction === "Right"){
                        col+=1;
                    } else {
                        row+=1;
                    }
                }
            }

            function updateSelectedWordLetters(topWord){
                selectedTopWordLetters = {};
                placeTopWordLetters(topWord, selectedTopWordLetters);
            }

            function createTopWordEntry(listIdx, topWord){
                let entry = document.createElement("div");
                entry.classList.add("top-word-entry");
                let text = `${topWord.word} (${topWord.score} points)`;
                entry.append(text);

                let viewEntryBtn = document.createElement("span");
                viewEntryBtn.classList.add("top-word-entry-btn");

                if(listIdx === selectedTopWordIdx) {
                    viewEntryBtn.innerText = "Hide";
                    viewEntryBtn.classList.add("hide-btn")
                } else {
                    viewEntryBtn.innerText = "View";
                    viewEntryBtn.classList.add("view-btn")
                }


                viewEntryBtn.onclick = () => {
                  if(selectedTopWordIdx === listIdx) {
                      //hide the word
                      selectedTopWordIdx = undefined;
                      selectedTopWordLetters = {};
                  } else {
                      //show the word on the board
                      updateSelectedWordLetters(topWord);
                      selectedTopWordIdx = listIdx;
                  }
                  render();
                };

                let placeEntryBtn = document.createElement("span");
                placeEntryBtn.innerText = "Place";
                placeEntryBtn.classList.add("top-word-entry-btn", "place-btn");
                placeEntryBtn.onclick = () => {
                    placeTopWordLetters(topWord, placedLetters);
                    render();
                };



                entry.append(viewEntryBtn);
                entry.append(placeEntryBtn);
                return entry;

            }

            function renderPlayerLetters(){
                let playerLettersDiv = document.getElementById("player-letters");
                playerLettersDiv.innerHTML = "";
                for(let i = 0; i<7; i++){
                    let cell = createPlayerLetterCell(i);
                    playerLettersDiv.append(cell);
                }
            }

            function renderTopWords(){
                let topWordsDiv = document.getElementById("top-words");
                topWordsDiv.innerHTML = "";
                for(const [idx,topWord] of topWords.entries()) {
                    let topWordEntry = createTopWordEntry(idx, topWord);
                    topWordsDiv.append(topWordEntry);
                }
            }

            function render(){
                renderBoard();
                renderPlayerLetters();
                renderTopWords();
            }

            window.onkeyup = function(evt) {
              let key = evt.key;
              let keyCode = key.charCodeAt(0);

              function isAlphaChar(key){
                  return key.length===1 &&
                      ((keyCode >=LOWER_A_CODE && keyCode <=LOWER_Z_CODE) ||
                      (keyCode >= UPPER_A_CODE && keyCode <=UPPER_Z_CODE));
              }

              function isBackspace(key) {
                  return key === BACKSPACE_KEY;
              }

              function isSpace(key){
                  return key === SPACE_KEY;
              }

              function isArrow(key) {
                  return ARROW_KEYS.includes(key);
              }

              if(selectedCol !== undefined && selectedRow !== undefined){

                   if (isAlphaChar(key)) {
                       // place a letter on the board
                          placedLetters[selectedRow] = placedLetters[selectedRow] || {};
                          placedLetters[selectedRow][selectedCol] = key;
                          render();
                  } else if (isBackspace(key)) {
                       // delete a letter on the board
                       placedLetters[selectedRow] = placedLetters[selectedRow] || {};
                       placedLetters[selectedRow][selectedCol] = undefined;
                       render();
                  } else if (isArrow(key)) {
                       // move the selected board position
                       let keyToMovement = {
                         [UP_KEY]:[-1,0],
                         [DOWN_KEY]:[1,0],
                         [RIGHT_KEY]:[0,1],
                         [LEFT_KEY]:[0,-1]
                       };
                       let dRow = keyToMovement[key][0];
                       let dCol = keyToMovement[key][1];

                       selectedRow = (selectedRow + dRow + 15)%15;
                       selectedCol = (selectedCol + dCol + 15)%15;
                       render();
                   }
              } else if (selectedPlayerLetter !== undefined) {
                if(isAlphaChar(key) || isSpace(key)) {
                    //add player tile
                    playerLetters[selectedPlayerLetter] = key;
                    render();
                } else if (isBackspace(key)) {
                    //delete player tile
                    playerLetters[selectedPlayerLetter] = undefined;
                    render();
                } else if (key === LEFT_KEY || key === RIGHT_KEY) {
                    let dTile = (key===RIGHT_KEY) || -1;
                    selectedPlayerLetter = (selectedPlayerLetter + dTile + 7)%7;
                    render();
                }
              }
            };

            //Prevent space/arrow keys from scrolling the page
            window.addEventListener("keydown", function(e) {
                // space and arrow keys
                if([UP_KEY,DOWN_KEY,LEFT_KEY,RIGHT_KEY,SPACE_KEY].includes(e.key)) {
                    e.preventDefault();
                }
            }, false);

            const findTopWordsBtn = document.getElementById("find-top-words");

            findTopWordsBtn.onclick = function(evt) {
                function createBoardSpecParam(){
                    let specParts = [];
                    for(let [rowIdx,row] of Object.entries(placedLetters)) {
                        for (let [colIdx, letter] of Object.entries(row)) {
                            if(letter !== undefined) {
                                specParts.push(`${rowIdx},${colIdx},${letter}`);
                            }
                        }
                    }
                    let spec = specParts.join(';');
                    return spec;
                }

                function createPlayerLettersParam(){
                    return playerLetters.filter(l => l!==undefined)
                        .map(l => l === ' ' ? '*': l)
                        .join('');
                }

                let boardSpecParam = createBoardSpecParam();
                let playerLettersParam = createPlayerLettersParam();
                let url = `/solutions?board_letters=${playerLettersParam}&board_spec=${boardSpecParam}`;
                fetch(url)
                    .then(resp => resp.json())
                    .then(jsonResp => {
                        if(jsonResp.error !== null){
                            alert(jsonResp.error);
                        } else {
                            topWords = jsonResp.solutions;
                            selectedTopWordIdx = undefined;
                            selectedTopWordLetters = {};
                            render();
                        }
                    });

            };

            //Initial rendering of the board
            render();

        </script>
    </body>
</html>
